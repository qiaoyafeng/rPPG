<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好心情 心率检测</title>
    <style>
        /* 基础样式 */
        body { font-family: Arial, sans-serif; margin: 1em; background: #f4f4f9; color: #333; }
        h1, h2 { text-align: center; color: #4a4a4a; }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.4em; }
        .container { max-width: 800px; margin: auto; background: white; padding: 1.5em; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .tab-container { display: flex; justify-content: center; margin-bottom: 1.5em; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom: 3px solid #007bff; }
        .panel { display: none; }
        .panel.active { display: block; }
        .upload-section, .webcam-section { text-align: center; padding: 1em 0; }
        
        /* 摄像头容器 - 使用相对单位 */
        #webcam-wrapper { position: relative; display: inline-block; margin: 1em auto; width: 100%; max-width: 640px; height: 0; padding-bottom: 75%; /* 4:3 比例 */ overflow: hidden; }
        #webcam-video, #overlay-canvas { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 8px; }
        #webcam-video { object-fit: cover; }
        #overlay-canvas { pointer-events: none; }
        
        /* 状态和结果显示 */
        #result { margin-top: 1em; font-size: 1.2em; font-weight: bold; text-align: left; padding: 1em; border-radius: 5px; background: #e7f3ff; color: #007bff; }
        #result h3 { text-align: center;}
        #result table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        #result th, #result td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        #result th { background-color: #f2f2f2; }
        
        /* 倒计时专用样式 */
        #status.countdown-active {
            font-size: 2.5em;
            font-weight: bold;
            color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            padding: 0.5em;
            border-radius: 8px;
        }
        
        /* 加载动画 */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 按钮样式 - 增大尺寸以便触摸操作 */
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin: 0.8em; min-width: 120px; }
        button:disabled { background-color: #cccccc; }
        input[type="file"] { margin: 1em 0; font-size: 1em; }
        
        /* 响应式设计 - 手机端适配 */
        @media (max-width: 768px) {
            body { margin: 0.5em; }
            .container { padding: 1em; }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.2em; }
            button { padding: 15px 25px; font-size: 1.2em; width: 80%; max-width: 250px; margin: 0.5em auto; display: block; }
            .tab { padding: 8px 15px; font-size: 0.9em; }
            #status, #result { font-size: 1.1em; padding: 0.8em; }
            #webcam-wrapper { max-width: 100%; }
        }
        
        /* 适配非常小的屏幕 */
        @media (max-width: 480px) {
            h1 { font-size: 1.3em; }
            h2 { font-size: 1.1em; }
            button { padding: 12px 20px; font-size: 1em; width: 90%; }
            #webcam-wrapper { padding-bottom: 133%; /* 3:4 竖屏比例，更适合手机竖屏使用 */ }
            
            /* 为移动设备添加更醒目的倒计时样式 */
            #status.countdown-active {
                font-size: 3em;
                color: #007bff;
            }
        }
        </style>
    <!-- Load face-api.js -->
    <script defer src="/static/face-api.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>好心情 远程心率检测</h1>

        <div class="tab-container">
            <div class="tab active" data-panel="upload">上传视频</div>
            <div class="tab" data-panel="webcam">摄像头录制</div>
        </div>

        <!-- Upload Panel -->
        <div id="upload-panel" class="panel active">
            <div class="upload-section">
                <h2>上传本地视频文件</h2>
                <input type="file" id="video-file-input" accept="video/*">
                <br>
                <button id="upload-button">上传并分析</button>
            </div>
        </div>

        <!-- Webcam Panel -->
        <div id="webcam-panel" class="panel">
            <div class="webcam-section">
                <h2>通过摄像头录制30秒</h2>
                <div id="webcam-wrapper">
                    <video id="webcam-video" autoplay muted playsinline></video>
                    <canvas id="overlay-canvas"></canvas>
                </div>
                <br>
                <button id="record-button">开始录制</button>
            </div>
        </div>

        <div id="status"></div>
        <div class="loader" id="loader"></div>
        <div id="result"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const allowWebcamFeature = {{ allow_webcam | tojson }};

        const videoFileInput = document.getElementById('video-file-input');
        const uploadButton = document.getElementById('upload-button');
        const recordButton = document.getElementById('record-button');
        const webcamVideo = document.getElementById('webcam-video');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const loader = document.getElementById('loader');
        
        // 初始化变量
        let mediaRecorder;
        let recordedChunks = [];
        let faceApiLoaded = false;
        let faceDetected = false;
        let faceDetectionInterval;
        
        // 设置录制按钮初始状态为可用
        recordButton.disabled = false;

        // --- Tab logic ---
        function showPanel(panelId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.tab[data-panel="${panelId}"]`);
            if(activeTab) activeTab.classList.add('active');
            
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${panelId}-panel`).classList.add('active');
            
            stopWebcam();
            if (panelId === 'webcam') {
                startWebcam();
            }
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => showPanel(tab.dataset.panel));
        });

        // --- FaceAPI setup ---
        async function loadFaceApi() {
            statusDiv.innerText = '正在加载人脸识别模型...';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('/static/weights');
                faceApiLoaded = true;
                statusDiv.innerText = '模型加载完毕。';
            } catch (e) {
                statusDiv.innerText = '加载人脸识别模型失败。请检查 /static/weights 目录中的文件。';
                console.error("FaceAPI model loading failed", e);
            }
        }

        // --- Webcam logic ---
        async function startWebcam() {
            if (!faceApiLoaded) await loadFaceApi();
            if (!faceApiLoaded) return; // Don't proceed if models failed to load
            try {
                // 优化视频约束，优先使用前置摄像头，并设置合适的分辨率
                const videoConstraints = {
                    facingMode: 'user', // 优先使用前置摄像头
                    width: {
                        ideal: 640,
                        max: 1280
                    },
                    height: {
                        ideal: 480,
                        max: 720
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints });
                webcamVideo.srcObject = stream;
                webcamVideo.onloadedmetadata = () => {
                    // 设置canvas尺寸以匹配视频
                    overlayCanvas.width = webcamVideo.videoWidth;
                    overlayCanvas.height = webcamVideo.videoHeight;
                    
                    // 响应式设计：移除固定尺寸设置
                    // 视频和Canvas的尺寸由CSS媒体查询和相对单位自动处理
                    // 移除所有style.width和style.height设置，让CSS接管布局
                    
                    // 确保录制按钮在摄像头启动后仍然可用
                    recordButton.disabled = false;
                    startFaceDetection();
                };
            } catch (error) {
                statusDiv.innerText = '无法访问摄像头。请授予权限。';
                console.error('Error accessing webcam:', error);
            }
        }

        function stopWebcam() {
            if (webcamVideo.srcObject) {
                webcamVideo.srcObject.getTracks().forEach(track => track.stop());
                webcamVideo.srcObject = null;
            }
            clearInterval(faceDetectionInterval);
            const context = overlayCanvas.getContext('2d');
            context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        }

        function startFaceDetection() {
            faceDetectionInterval = setInterval(async () => {
                // 配置TinyFaceDetectorOptions，设置低置信度阈值以确保捕捉所有可能的人脸
                const options = new faceapi.TinyFaceDetectorOptions({
                    inputSize: 320,
                    scoreThreshold: 0.0 // 设置最低置信度阈值，确保不过滤任何检测到的人脸
                });
                const detections = await faceapi.detectAllFaces(webcamVideo, options);
                const context = overlayCanvas.getContext('2d');
                context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                
                // 无论是否检测到人脸，都保持录制按钮可用状态
                if (detections.length > 0) {
                    faceDetected = true;
                    // 完全移除状态文本更新，避免干扰倒计时显示
                    // 只绘制检测框，不更新状态文本
                    faceapi.draw.drawDetections(overlayCanvas, detections);
                } else {
                    faceDetected = false;
                    // 完全移除状态文本更新，避免干扰倒计时显示
                }
            }, 500);
        }

        // --- Recording logic ---
        recordButton.addEventListener('click', () => {
            // 移除人脸检测检查，允许用户随时开始录制
            recordButton.disabled = true;
            recordedChunks = [];
            const stream = webcamVideo.srcObject;
            // 配置录制选项，尝试实现30帧每秒的帧率
            const options = {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 5000000, // 5Mbps的比特率
                // 注意：浏览器可能不支持精确控制帧率，但通过高比特率可以提高录制质量
            };
            mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                const videoFile = new File([videoBlob], 'webcam-recording.webm', { type: 'video/webm' });
                const formData = new FormData();
                formData.append('file', videoFile);
                uploadVideo(formData);
            };

            mediaRecorder.start();
            
            // 使用更可靠的倒计时实现，确保在手机浏览器上正确显示
            const duration = 30; // 30秒
            const startTime = Date.now();
            
            // 添加倒计时专用样式类
            statusDiv.classList.add('countdown-active');
            
            function updateCountdown() {
                try {
                    // 计算剩余时间
                    const elapsed = (Date.now() - startTime) / 1000;
                    const remaining = Math.max(0, Math.ceil(duration - elapsed));
                    
                    // 使用textContent代替innerText以提高兼容性
                    statusDiv.textContent = `${remaining}s`;
                    
                    // 检查录制状态
                    if (mediaRecorder && mediaRecorder.state === 'recording' && remaining > 0) {
                        // 使用setTimeout而不是setInterval来确保更稳定的更新
                        setTimeout(updateCountdown, 500); // 每500ms更新一次，提高响应性
                    } else if (mediaRecorder && mediaRecorder.state === 'recording') {
                        // 时间到，停止录制
                        statusDiv.classList.remove('countdown-active');
                        mediaRecorder.stop();
                    } else {
                        // 录制已停止，清理样式
                        statusDiv.classList.remove('countdown-active');
                    }
                } catch (e) {
                    console.error('Error in countdown:', e);
                    // 出错时清理
                    statusDiv.classList.remove('countdown-active');
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }
            }
            
            // 启动倒计时更新
            updateCountdown();
        });

        // --- Upload logic ---
        uploadButton.addEventListener('click', () => {
            const file = videoFileInput.files[0];
            if (!file) {
                statusDiv.innerText = '请先选择一个文件。';
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            uploadVideo(formData);
        });

        async function uploadVideo(formData) {
            statusDiv.classList.remove('countdown-active');
            statusDiv.textContent = '正在上传并分析视频...';
            loader.style.display = 'block';
            resultDiv.textContent = '';

            try {
                const response = await fetch('/predict/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '上传失败。');
                }

                const data = await response.json();
                const taskId = data.task_id;
                statusDiv.textContent = '视频上传成功，正在后台处理...';
                
                // Start polling for the result
                pollTask(taskId);

            } catch (error) {
                resultDiv.innerText = `错误：${error.message}`;
                statusDiv.textContent = '处理失败。';
                loader.style.display = 'none';
                recordButton.disabled = false;
            }
        }

        async function pollTask(taskId) {
            try {
                const response = await fetch(`/task_status/${taskId}`);
                
                if (!response.ok) {
                    // If the server returns a 404 or other error, stop polling
                    throw new Error('任务状态查询失败。');
                }

                const data = await response.json();

                if (data.status === 'processing') {
                    // If still processing, poll again after 3 seconds
                    setTimeout(() => pollTask(taskId), 3000);
                } else if (data.status === 'completed') {
                    // If completed, display the result
                    const result = data.result;
                    let resultHTML = `<h3>检测结果：</h3>
                                      <p><strong>心率:</strong> ${result.heart_rate} ${result.units.heart_rate}</p>
                                      <h4>HRV 指标:</h4>
                                      <table>
                                        <tr><th>指标</th><th>值</th><th>单位</th></tr>
                                        <tr><td>RMSSD</td><td>${result.hrv_metrics.rmssd}</td><td>${result.units.rmssd}</td></tr>
                                        <tr><td>SDNN</td><td>${result.hrv_metrics.sdnn}</td><td>${result.units.sdnn}</td></tr>
                                        <tr><td>pNN50</td><td>${result.hrv_metrics.pnn50}</td><td>%</td></tr>
                                      </table>
                                      <p><strong>HRV 健康指数:</strong> ${result.hrv_health.index} (${result.hrv_health.range})</p>
                                      <p><strong>压力水平:</strong> ${result.stress.score} (${result.stress.range})</p>`;
                    resultDiv.innerHTML = resultHTML;
                    statusDiv.textContent = '分析完成。';
                    loader.style.display = 'none';
                    recordButton.disabled = false;
                } else if (data.status === 'error') {
                    // If there was an error, show the error message
                    throw new Error(data.detail || '处理过程中发生未知错误。');
                }

            } catch (error) {
                resultDiv.innerText = `错误：${error.message}`;
                statusDiv.textContent = '处理失败。';
                loader.style.display = 'none';
                recordButton.disabled = false;
            }
        }

        // Initialize
        const webcamTab = document.querySelector('.tab[data-panel="webcam"]');
        if (!allowWebcamFeature) {
            if (webcamTab) {
                webcamTab.style.display = 'none';
            }
        }
        showPanel('upload'); // 默认显示上传面板
    });
    </script>
</body>
</html>
